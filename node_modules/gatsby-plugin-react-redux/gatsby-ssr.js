"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

exports.__esModule = true;
exports.onRenderBody = exports.wrapRootElement = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _react = _interopRequireDefault(require("react"));

var _reactRedux = require("react-redux");

var _serializeJavascript = _interopRequireDefault(require("serialize-javascript"));

var _createStore = _interopRequireDefault(require("./.tmp/createStore"));

var _constants = require("./constants");

var storesByPaths = new Map();

var wrapRootElement = function wrapRootElement(_ref) {
  var element = _ref.element,
      pathname = _ref.pathname;
  var store = (0, _createStore["default"])();
  storesByPaths.set(pathname, store);
  return _react["default"].createElement(_reactRedux.Provider, {
    store: store
  }, element);
};

exports.wrapRootElement = wrapRootElement;

var onRenderBody = function onRenderBody(_ref2, pluginOptions) {
  var setHeadComponents = _ref2.setHeadComponents,
      pathname = _ref2.pathname;

  if (pluginOptions === void 0) {
    pluginOptions = {};
  }

  if (process.env.BUILD_STAGE !== 'build-html') {
    return;
  }

  var store = storesByPaths.get(pathname);
  if (!store) return;
  var options = (0, _extends2["default"])({}, _constants.DEFAULT_OPTIONS, {}, pluginOptions);
  var serializedState = (0, _serializeJavascript["default"])(store.getState(), options.serialize).replace(/'/g, "\\'"); // escape single quotes inside because we wrap it in them

  var parseFn = options.serialize.isJSON ? 'JSON.parse' : 'eval';
  setHeadComponents([_react["default"].createElement("script", {
    key: "redux-state",
    id: _constants.SCRIPT_ELEMENT_ID,
    dangerouslySetInnerHTML: {
      __html: "window['" + options.windowKey + "'] = " + parseFn + "('" + serializedState + "')"
    }
  })]);
  storesByPaths["delete"](pathname);
};

exports.onRenderBody = onRenderBody;